name: Repository Audit

on:
  # Run weekly on Mondays at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      depth:
        description: 'Audit depth (quick, standard, full)'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - full

jobs:
  audit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run audit agent
        id: audit
        run: |
          DEPTH="${{ github.event.inputs.depth || 'standard' }}"
          echo "Running audit with depth: $DEPTH"

          cd scripts/audit-agent
          python3 core.py --repo ../.. --depth $DEPTH --output audit-report.json

      - name: Display audit summary
        if: always()
        run: |
          if [ -f scripts/audit-agent/audit-report.json ]; then
            echo "## Audit Summary"
            python3 <<'PYTHON_SCRIPT'
            import json
            import sys

            with open('scripts/audit-agent/audit-report.json') as f:
                report = json.load(f)

            print('### Project Context')
            ctx = report['context']
            print(f"- Languages: {', '.join(ctx['languages']) or 'None'}")
            print(f"- Frameworks: {', '.join(ctx['frameworks']) or 'None'}")
            print(f"- Cloud Providers: {', '.join(ctx['cloud_providers']) or 'None'}")
            print(f"- Maturity: {ctx['maturity']}")
            print()

            print('### Rules Selection')
            rules = report['rules_selection_report']
            print(f"- Total rules available: {rules['total_rules_available']}")
            print(f"- Rules selected: {rules['total_rules_selected']}")
            print(f"- Estimated tokens: {rules['total_estimated_tokens']}")
            print(f"- Selection efficiency: {rules['selection_efficiency']}")
            print()

            if report.get('mece_content_map'):
                print('### MECE Analysis')
                mece = report['mece_content_map']
                print(f"- Files analyzed: {mece.get('files_analyzed', 0)}")
                print()

            if report.get('file_disposition'):
                print('### File Disposition')
                disp = report['file_disposition']
                print(f"- Total files: {disp.get('total_files', 0)}")
                print(f"- Redundant: {disp.get('redundant', 0)}")
                print(f"- Obsolete: {disp.get('obsolete', 0)}")
                print()
            PYTHON_SCRIPT
          else
            echo "Audit report not found"
            exit 1
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-report-${{ github.run_id }}
          path: scripts/audit-agent/audit-report.json
          retention-days: 90

      - name: Create issue for findings (if any)
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -f scripts/audit-agent/audit-report.json ]; then
            python3 <<'PYTHON_SCRIPT' || echo "Issue creation skipped or failed"
            import json
            import os
            import subprocess

            with open('scripts/audit-agent/audit-report.json') as f:
                report = json.load(f)

            # Check if there are any actionable findings
            disposition = report.get('file_disposition', {})
            obsolete_count = disposition.get('obsolete', 0)
            redundant_count = disposition.get('redundant', 0)

            if obsolete_count > 0 or redundant_count > 0:
                # Create GitHub issue
                title = f'Repository Audit Findings - {report["timestamp"][:10]}'

                body = f'''## Audit Report

            **Generated**: {report['timestamp']}
            **Depth**: {report.get('config', {}).get('depth', 'standard')}

            ### Project Context
            - Languages: {', '.join(report['context']['languages']) or 'None'}
            - Frameworks: {', '.join(report['context']['frameworks']) or 'None'}
            - Maturity: {report['context']['maturity']}

            ### Findings

            #### File Disposition
            - Obsolete files: {obsolete_count}
            - Redundant files: {redundant_count}

            '''

                if disposition.get('recommendations'):
                    body += '### Recommendations\n\n'
                    for rec in disposition['recommendations'][:5]:
                        body += f"- {rec['file']}: {rec['action']} ({rec['status']})\n"

                body += f'''

            View full report in [artifacts](https://github.com/{os.environ['GITHUB_REPOSITORY']}/actions/runs/{os.environ['GITHUB_RUN_ID']})
            '''

                # Use gh CLI to create issue
                subprocess.run([
                    'gh', 'issue', 'create',
                    '--title', title,
                    '--body', body,
                    '--label', 'audit',
                    '--label', 'automated'
                ], check=True)

                print(f'Created issue: {title}')
            else:
                print('No actionable findings - skipping issue creation')
            PYTHON_SCRIPT
          fi

      - name: Comment on PR (if triggered by PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('scripts/audit-agent/audit-report.json', 'utf8'));

            const rules = report.rules_selection_report;
            const comment = `## üîç Repository Audit Report

### Rules Selected
- **Total available**: ${rules.total_rules_available}
- **Selected**: ${rules.total_rules_selected}
- **Token efficiency**: ${rules.selection_efficiency}

<details>
<summary>View selected rules</summary>

${rules.selected_rules.slice(0, 5).map(r => `- ${r.name} (${r.category})`).join('\n')}

</details>

Full report available in [workflow artifacts](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
