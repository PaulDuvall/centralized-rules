name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-progressive-disclosure:
    name: Validate Progressive Disclosure Architecture
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run progressive disclosure validation
        run: |
          chmod +x scripts/validate-progressive-disclosure.sh
          ./scripts/validate-progressive-disclosure.sh
        env:
          RUN_PROJECT_TEST: "true"

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            .claude/
            scripts/
          retention-days: 5

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on all shell scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          format: gcc

      - name: Run ShellCheck on sync script
        uses: ludeeus/action-shellcheck@master
        with:
          check_together: 'yes'
          scandir: '.'
          format: gcc
          severity: warning
        env:
          SHELLCHECK_OPTS: -e SC2086

  test-sync-script:
    name: Test Sync Script
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "Python + FastAPI"
            project-type: python-fastapi
            files: |
              pyproject.toml
              src/main.py
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "test-project"
              version = "0.1.0"
              dependencies = ["fastapi", "pytest"]
              EOF
              mkdir -p src
              echo 'from fastapi import FastAPI' > src/main.py

          - name: "TypeScript + React"
            project-type: typescript-react
            files: |
              package.json
              src/App.tsx
            setup: |
              cat > package.json <<'EOF'
              {
                "name": "test-project",
                "version": "1.0.0",
                "dependencies": {
                  "react": "^18.0.0",
                  "typescript": "^5.0.0"
                }
              }
              EOF
              mkdir -p src
              echo 'import React from "react";' > src/App.tsx

          - name: "Go + Gin API"
            project-type: go-api
            files: |
              go.mod
              cmd/main.go
            setup: |
              cat > go.mod <<'EOF'
              module example.com/test

              go 1.21

              require (
                  github.com/gin-gonic/gin v1.9.0
              )
              EOF
              mkdir -p cmd
              echo 'package main' > cmd/main.go

          - name: "Python + Django + PostgreSQL"
            project-type: python-django-postgres
            files: |
              pyproject.toml
              requirements.txt
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "app"
              dependencies = ["django", "psycopg2-binary", "pytest"]
              EOF
              cat > requirements.txt <<'EOF'
              Django>=4.2
              psycopg2-binary>=2.9
              EOF

          - name: "TypeScript + Next.js + AWS"
            project-type: typescript-nextjs-aws
            files: |
              package.json
              tsconfig.json
            setup: |
              cat > package.json <<'EOF'
              {
                "dependencies": {
                  "next": "14.0.0",
                  "react": "18.0.0",
                  "aws-sdk": "2.0.0"
                },
                "devDependencies": {
                  "typescript": "5.0.0"
                }
              }
              EOF
              cat > tsconfig.json <<'EOF'
              {
                "compilerOptions": {
                  "target": "ES2020"
                }
              }
              EOF

          - name: "Go + Gin + AWS + Docker"
            project-type: go-gin-aws-docker
            files: |
              go.mod
              Dockerfile
              aws-config.yml
            setup: |
              cat > go.mod <<'EOF'
              module example.com/app

              go 1.21

              require github.com/gin-gonic/gin v1.9.0
              EOF
              cat > Dockerfile <<'EOF'
              FROM golang:1.21
              EOF
              cat > aws-config.yml <<'EOF'
              region: us-east-1
              EOF

          - name: "Multi-language (Python + TypeScript)"
            project-type: multi-python-typescript
            files: |
              pyproject.toml
              package.json
              src/main.py
              ui/app.tsx
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "backend"
              EOF
              cat > package.json <<'EOF'
              {
                "name": "frontend"
              }
              EOF
              mkdir -p src ui
              echo '# Backend' > src/main.py
              echo '// Frontend' > ui/app.tsx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test project (${{ matrix.name }})
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          ${{ matrix.setup }}

      - name: Copy sync script to test project
        run: |
          cp sync-ai-rules.sh /tmp/test-project/
          chmod +x /tmp/test-project/sync-ai-rules.sh

      - name: Run sync script
        run: |
          cd /tmp/test-project
          ./sync-ai-rules.sh

      - name: Validate generated files
        run: |
          cd /tmp/test-project

          # Check AGENTS.md was generated
          if [ ! -f .claude/AGENTS.md ]; then
            echo "ERROR: .claude/AGENTS.md not generated"
            exit 1
          fi
          echo "✓ AGENTS.md generated"

          # Check progressive disclosure instructions present
          if ! grep -q "DO NOT load all rule files at once" .claude/AGENTS.md; then
            echo "ERROR: Progressive disclosure warning missing"
            exit 1
          fi
          echo "✓ Progressive disclosure warning present"

          # Check rules directory structure
          if [ ! -d .claude/rules ]; then
            echo "ERROR: .claude/rules directory not created"
            exit 1
          fi
          echo "✓ Rules directory structure created"

          echo "✅ All validations passed for ${{ matrix.name }}"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-project-${{ matrix.project-type }}
          path: /tmp/test-project/.claude/
          retention-days: 5

  verify-documentation:
    name: Verify Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README mentions progressive disclosure
        run: |
          if ! grep -qi "progressive disclosure" README.md; then
            echo "ERROR: README.md doesn't mention progressive disclosure"
            exit 1
          fi
          echo "✓ README.md documents progressive disclosure"

      - name: Check ARCHITECTURE documentation
        run: |
          if [ -f ARCHITECTURE.md ]; then
            if ! grep -qi "progressive disclosure" ARCHITECTURE.md; then
              echo "ERROR: ARCHITECTURE.md doesn't explain progressive disclosure"
              exit 1
            fi
            echo "✓ ARCHITECTURE.md explains progressive disclosure"
          else
            echo "WARNING: ARCHITECTURE.md not found"
          fi

      - name: Verify rule files are markdown
        run: |
          # Check that all rule files are .md
          non_md=$(find base/ languages/ frameworks/ cloud/ -type f ! -name "*.md" 2>/dev/null || true)
          if [ -n "$non_md" ]; then
            echo "ERROR: Non-markdown files found in rule directories:"
            echo "$non_md"
            exit 1
          fi
          echo "✓ All rule files are markdown"

      - name: Check for broken internal links
        run: |
          # Simple check for broken relative links in markdown files
          for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.claude/*"); do
            echo "Checking $file..."
            # This is a basic check - could be enhanced with a proper link checker
            if grep -o '\[.*\](\.\/[^)]*\.md)' "$file" > /dev/null; then
              echo "  Found internal links"
            fi
          done
          echo "✓ Internal link check complete"

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs:
      - validate-progressive-disclosure
      - shellcheck
      - test-sync-script
      - verify-documentation
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.validate-progressive-disclosure.result }}" != "success" ] || \
             [ "${{ needs.shellcheck.result }}" != "success" ] || \
             [ "${{ needs.test-sync-script.result }}" != "success" ] || \
             [ "${{ needs.verify-documentation.result }}" != "success" ]; then
            echo "One or more test jobs failed"
            exit 1
          fi
          echo "✅ All tests passed!"
