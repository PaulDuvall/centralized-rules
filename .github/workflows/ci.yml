name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Progressive Disclosure Validation
  progressive-disclosure:
    name: Progressive Disclosure
    uses: ./.github/workflows/ci-progressive-disclosure.yml

  # Code Quality Checks (ShellCheck + Documentation)
  quality:
    name: Code Quality
    uses: ./.github/workflows/ci-quality.yml

  # Sync Script Integration Tests
  sync-script:
    name: Sync Script Tests
    uses: ./.github/workflows/ci-sync-script.yml

  # Claude Skill Tests
  skill:
    name: Claude Skill
    uses: ./.github/workflows/ci-skill.yml

  # Keyword Validation Tests
  keyword-validation:
    name: Keyword Validation
    uses: ./.github/workflows/ci-keyword-validation.yml

  # Generate comprehensive test report
  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs:
      - progressive-disclosure
      - quality
      - sync-script
      - skill
      - keyword-validation
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate comprehensive test report
        run: |
          cat > test-report.md << 'REPORT_EOF'
          # üöÄ CI Test Report

          **Workflow Run:** ${{ github.run_number }}
          **Commit:** `${{ github.sha }}`
          **Branch:** `${{ github.ref_name }}`
          **Triggered by:** ${{ github.event_name }}
          **Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ---

          ## üìä Test Results Summary

          | Test Suite | Status | Details |
          |-----------|---------|---------|
          | üìã Progressive Disclosure Validation | ${{ needs.progressive-disclosure.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Claude + Cursor + Copilot configs validated |
          | üîç Code Quality | ${{ needs.quality.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | ShellCheck + Documentation verification |
          | üß™ Sync Script Testing | ${{ needs.sync-script.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | **20+ comprehensive scenarios** |
          | ‚ö° Claude Skill Tests | ${{ needs.skill.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | TypeScript compilation, tests, 85% coverage |

          ---

          ## üéØ Overall Status

          REPORT_EOF

          # Determine overall status
          if [ "${{ needs.progressive-disclosure.result }}" == "success" ] && \
             [ "${{ needs.quality.result }}" == "success" ] && \
             [ "${{ needs.sync-script.result }}" == "success" ] && \
             [ "${{ needs.skill.result }}" == "success" ]; then
            echo "### ‚úÖ ALL TESTS PASSED" >> test-report.md
            echo "" >> test-report.md
            echo "All test suites completed successfully. The progressive disclosure architecture is validated and working correctly across all scenarios." >> test-report.md
            overall_status="success"
          else
            echo "### ‚ùå TESTS FAILED" >> test-report.md
            echo "" >> test-report.md
            echo "One or more test suites failed. Please review the individual test results above and check the workflow logs for details." >> test-report.md
            echo "" >> test-report.md
            echo "#### Failed Tests:" >> test-report.md
            [ "${{ needs.progressive-disclosure.result }}" != "success" ] && echo "- Progressive Disclosure Validation" >> test-report.md
            [ "${{ needs.quality.result }}" != "success" ] && echo "- Code Quality" >> test-report.md
            [ "${{ needs.sync-script.result }}" != "success" ] && echo "- Sync Script Testing" >> test-report.md
            [ "${{ needs.skill.result }}" != "success" ] && echo "- Claude Skill Tests" >> test-report.md
            overall_status="failure"
          fi

          echo "" >> test-report.md
          echo "---" >> test-report.md
          echo "" >> test-report.md
          echo "**Workflow URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> test-report.md

          # Output to job summary
          cat test-report.md >> $GITHUB_STEP_SUMMARY

          # Save status for next step
          echo "status=$overall_status" >> $GITHUB_OUTPUT
        id: report

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
          retention-days: 30

      - name: Fail if tests failed
        if: steps.report.outputs.status != 'success'
        run: |
          echo "‚ùå One or more test suites failed"
          exit 1
