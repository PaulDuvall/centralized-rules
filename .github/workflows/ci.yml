name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate-progressive-disclosure:
    name: Validate Progressive Disclosure Architecture
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run progressive disclosure validation
        id: validation
        run: |
          chmod +x scripts/validate-progressive-disclosure.sh
          ./scripts/validate-progressive-disclosure.sh | tee validation-output.txt
          echo "result=$?" >> $GITHUB_OUTPUT
        env:
          RUN_PROJECT_TEST: "true"
        continue-on-error: true

      - name: Generate validation summary
        if: always()
        run: |
          echo "## üìã Progressive Disclosure Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.validation.outputs.result }}" == "0" ]; then
            echo "‚úÖ **Status:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Performed" >> $GITHUB_STEP_SUMMARY
          echo "- Directory structure validation" >> $GITHUB_STEP_SUMMARY
          echo "- AGENTS.md configuration check" >> $GITHUB_STEP_SUMMARY
          echo "- Base rules language-agnostic validation" >> $GITHUB_STEP_SUMMARY
          echo "- Generated RULES.md verification" >> $GITHUB_STEP_SUMMARY
          echo "- Sync script functionality test" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation completeness check" >> $GITHUB_STEP_SUMMARY
          echo "- Real project integration test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f validation-output.txt ]; then
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>View detailed output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -100 validation-output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: |
            validation-output.txt
            .claude/
            scripts/
          retention-days: 5

      - name: Fail if validation failed
        if: steps.validation.outputs.result != '0'
        run: exit 1

  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run ShellCheck on all shell scripts
        id: shellcheck-scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './scripts'
          severity: warning
          format: gcc
        continue-on-error: true

      - name: Run ShellCheck on sync script
        id: shellcheck-sync
        uses: ludeeus/action-shellcheck@master
        with:
          check_together: 'yes'
          scandir: '.'
          format: gcc
          severity: warning
        env:
          SHELLCHECK_OPTS: -e SC2086
        continue-on-error: true

      - name: Generate ShellCheck summary
        if: always()
        run: |
          echo "## üîç ShellCheck Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          scripts_status="${{ steps.shellcheck-scripts.outcome }}"
          sync_status="${{ steps.shellcheck-sync.outcome }}"

          if [ "$scripts_status" == "success" ] && [ "$sync_status" == "success" ]; then
            echo "‚úÖ **Status:** ALL CHECKS PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** ISSUES FOUND" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scanned Files" >> $GITHUB_STEP_SUMMARY
          echo "- **Scripts directory:** $scripts_status" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync script (root):** $sync_status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checks Performed" >> $GITHUB_STEP_SUMMARY
          echo "- Syntax errors" >> $GITHUB_STEP_SUMMARY
          echo "- Common pitfalls (SC codes)" >> $GITHUB_STEP_SUMMARY
          echo "- Best practices violations" >> $GITHUB_STEP_SUMMARY
          echo "- Security issues" >> $GITHUB_STEP_SUMMARY

      - name: Fail if ShellCheck found issues
        if: steps.shellcheck-scripts.outcome != 'success' || steps.shellcheck-sync.outcome != 'success'
        run: exit 1

  test-sync-script:
    name: Test Sync Script
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - name: "Python + FastAPI"
            project-type: python-fastapi
            files: |
              pyproject.toml
              src/main.py
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "test-project"
              version = "0.1.0"
              dependencies = ["fastapi", "pytest"]
              EOF
              mkdir -p src
              echo 'from fastapi import FastAPI' > src/main.py

          - name: "TypeScript + React"
            project-type: typescript-react
            files: |
              package.json
              src/App.tsx
            setup: |
              cat > package.json <<'EOF'
              {
                "name": "test-project",
                "version": "1.0.0",
                "dependencies": {
                  "react": "^18.0.0",
                  "typescript": "^5.0.0"
                }
              }
              EOF
              mkdir -p src
              echo 'import React from "react";' > src/App.tsx

          - name: "Go + Gin API"
            project-type: go-api
            files: |
              go.mod
              cmd/main.go
            setup: |
              cat > go.mod <<'EOF'
              module example.com/test

              go 1.21

              require (
                  github.com/gin-gonic/gin v1.9.0
              )
              EOF
              mkdir -p cmd
              echo 'package main' > cmd/main.go

          - name: "Python + Django + PostgreSQL"
            project-type: python-django-postgres
            files: |
              pyproject.toml
              requirements.txt
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "app"
              dependencies = ["django", "psycopg2-binary", "pytest"]
              EOF
              cat > requirements.txt <<'EOF'
              Django>=4.2
              psycopg2-binary>=2.9
              EOF

          - name: "TypeScript + Next.js + AWS"
            project-type: typescript-nextjs-aws
            files: |
              package.json
              tsconfig.json
            setup: |
              cat > package.json <<'EOF'
              {
                "dependencies": {
                  "next": "14.0.0",
                  "react": "18.0.0",
                  "aws-sdk": "2.0.0"
                },
                "devDependencies": {
                  "typescript": "5.0.0"
                }
              }
              EOF
              cat > tsconfig.json <<'EOF'
              {
                "compilerOptions": {
                  "target": "ES2020"
                }
              }
              EOF

          - name: "Go + Gin + AWS + Docker"
            project-type: go-gin-aws-docker
            files: |
              go.mod
              Dockerfile
              aws-config.yml
            setup: |
              cat > go.mod <<'EOF'
              module example.com/app

              go 1.21

              require github.com/gin-gonic/gin v1.9.0
              EOF
              cat > Dockerfile <<'EOF'
              FROM golang:1.21
              EOF
              cat > aws-config.yml <<'EOF'
              region: us-east-1
              EOF

          - name: "Multi-language (Python + TypeScript)"
            project-type: multi-python-typescript
            files: |
              pyproject.toml
              package.json
              src/main.py
              ui/app.tsx
            setup: |
              cat > pyproject.toml <<'EOF'
              [project]
              name = "backend"
              EOF
              cat > package.json <<'EOF'
              {
                "name": "frontend"
              }
              EOF
              mkdir -p src ui
              echo '# Backend' > src/main.py
              echo '// Frontend' > ui/app.tsx

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create test project (${{ matrix.name }})
        run: |
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          ${{ matrix.setup }}

      - name: Copy sync script to test project
        run: |
          cp sync-ai-rules.sh /tmp/test-project/
          chmod +x /tmp/test-project/sync-ai-rules.sh

      - name: Run sync script
        run: |
          cd /tmp/test-project
          ./sync-ai-rules.sh

      - name: Validate generated files
        id: validate
        run: |
          cd /tmp/test-project

          # Check AGENTS.md was generated
          if [ ! -f .claude/AGENTS.md ]; then
            echo "ERROR: .claude/AGENTS.md not generated"
            exit 1
          fi
          echo "‚úì AGENTS.md generated"

          # Check progressive disclosure instructions present
          if ! grep -q "DO NOT load all rule files at once" .claude/AGENTS.md; then
            echo "ERROR: Progressive disclosure warning missing"
            exit 1
          fi
          echo "‚úì Progressive disclosure warning present"

          # Check rules directory structure
          if [ ! -d .claude/rules ]; then
            echo "ERROR: .claude/rules directory not created"
            exit 1
          fi
          echo "‚úì Rules directory structure created"

          echo "‚úÖ All validations passed for ${{ matrix.name }}"
        continue-on-error: true

      - name: Generate test summary
        if: always()
        run: |
          echo "## üß™ Sync Script Test: ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "‚úÖ **Status:** PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Project Type" >> $GITHUB_STEP_SUMMARY
          echo "${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validations Performed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì AGENTS.md generation" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì Progressive disclosure warnings" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì Rules directory structure" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úì Language/framework detection" >> $GITHUB_STEP_SUMMARY

      - name: Fail if validation failed
        if: steps.validate.outcome != 'success'
        run: exit 1

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-project-${{ matrix.project-type }}
          path: /tmp/test-project/.claude/
          retention-days: 5

  verify-documentation:
    name: Verify Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README mentions progressive disclosure
        id: check-readme
        run: |
          if ! grep -qi "progressive disclosure" README.md; then
            echo "ERROR: README.md doesn't mention progressive disclosure"
            exit 1
          fi
          echo "‚úì README.md documents progressive disclosure"
        continue-on-error: true

      - name: Check ARCHITECTURE documentation
        id: check-arch
        run: |
          if [ -f ARCHITECTURE.md ]; then
            if ! grep -qi "progressive disclosure" ARCHITECTURE.md; then
              echo "ERROR: ARCHITECTURE.md doesn't explain progressive disclosure"
              exit 1
            fi
            echo "‚úì ARCHITECTURE.md explains progressive disclosure"
          else
            echo "WARNING: ARCHITECTURE.md not found"
          fi
        continue-on-error: true

      - name: Verify rule files are markdown
        id: check-markdown
        run: |
          # Check that all rule files are .md
          non_md=$(find base/ languages/ frameworks/ cloud/ -type f ! -name "*.md" 2>/dev/null || true)
          if [ -n "$non_md" ]; then
            echo "ERROR: Non-markdown files found in rule directories:"
            echo "$non_md"
            exit 1
          fi
          echo "‚úì All rule files are markdown"
        continue-on-error: true

      - name: Check for broken internal links
        id: check-links
        run: |
          # Simple check for broken relative links in markdown files
          for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.claude/*"); do
            echo "Checking $file..."
            # This is a basic check - could be enhanced with a proper link checker
            if grep -o '\[.*\](\.\/[^)]*\.md)' "$file" > /dev/null; then
              echo "  Found internal links"
            fi
          done
          echo "‚úì Internal link check complete"
        continue-on-error: true

      - name: Generate documentation verification summary
        if: always()
        run: |
          echo "## üìö Documentation Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          readme="${{ steps.check-readme.outcome }}"
          arch="${{ steps.check-arch.outcome }}"
          markdown="${{ steps.check-markdown.outcome }}"
          links="${{ steps.check-links.outcome }}"

          if [ "$readme" == "success" ] && [ "$arch" == "success" ] && [ "$markdown" == "success" ] && [ "$links" == "success" ]; then
            echo "‚úÖ **Status:** ALL CHECKS PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Status:** SOME CHECKS FAILED" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Documentation Checks" >> $GITHUB_STEP_SUMMARY
          echo "- **README progressive disclosure:** $readme" >> $GITHUB_STEP_SUMMARY
          echo "- **ARCHITECTURE documentation:** $arch" >> $GITHUB_STEP_SUMMARY
          echo "- **Rule files are markdown:** $markdown" >> $GITHUB_STEP_SUMMARY
          echo "- **Internal links:** $links" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: steps.check-readme.outcome != 'success' || steps.check-arch.outcome != 'success' || steps.check-markdown.outcome != 'success' || steps.check-links.outcome != 'success'
        run: exit 1

  generate-test-report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs:
      - validate-progressive-disclosure
      - shellcheck
      - test-sync-script
      - verify-documentation
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate comprehensive test report
        run: |
          cat > test-report.md << 'REPORT_EOF'
          # üöÄ CI Test Report

          **Workflow Run:** ${{ github.run_number }}
          **Commit:** `${{ github.sha }}`
          **Branch:** `${{ github.ref_name }}`
          **Triggered by:** ${{ github.event_name }}
          **Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ---

          ## üìä Test Results Summary

          | Test Suite | Status | Details |
          |-----------|---------|---------|
          | üìã Progressive Disclosure Validation | ${{ needs.validate-progressive-disclosure.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Architecture validation & real project testing |
          | üîç ShellCheck Linting | ${{ needs.shellcheck.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Bash script quality & security checks |
          | üß™ Sync Script Testing | ${{ needs.test-sync-script.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | 7 project type scenarios tested |
          | üìö Documentation Verification | ${{ needs.verify-documentation.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }} | Documentation completeness & quality |

          ---

          ## üìã Progressive Disclosure Validation

          **Status:** ${{ needs.validate-progressive-disclosure.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}

          ### Tests Performed
          - ‚úì Directory structure compliance (`base/`, `languages/`, `frameworks/`, `cloud/`)
          - ‚úì AGENTS.md configuration validation
          - ‚úì Base rules language-agnostic verification
          - ‚úì Generated RULES.md progressive disclosure check
          - ‚úì Sync script functionality test
          - ‚úì Documentation completeness check
          - ‚úì Real project integration test (Python + FastAPI)

          ### Artifacts
          - `validation-results` - Complete validation output and generated files

          ---

          ## üîç ShellCheck Linting

          **Status:** ${{ needs.shellcheck.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}

          ### Scanned Files
          - Shell scripts in `scripts/` directory
          - Root-level `sync-ai-rules.sh`

          ### Checks Performed
          - ‚úì Syntax errors
          - ‚úì Common pitfalls (SC codes)
          - ‚úì Best practices violations
          - ‚úì Security issues

          ---

          ## üß™ Sync Script Testing

          **Status:** ${{ needs.test-sync-script.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}

          ### Project Types Tested
          1. **Python + FastAPI** - Basic Python web framework
          2. **TypeScript + React** - Frontend with TypeScript
          3. **Go + Gin API** - Go REST API
          4. **Python + Django + PostgreSQL** - Full-stack Python with database
          5. **TypeScript + Next.js + AWS** - Cloud-integrated frontend
          6. **Go + Gin + AWS + Docker** - Containerized cloud API
          7. **Multi-language (Python + TypeScript)** - Polyglot project

          ### Validations Per Project
          - ‚úì AGENTS.md generation with correct content
          - ‚úì Progressive disclosure warnings present
          - ‚úì Rules directory structure created
          - ‚úì Language/framework/cloud detection accuracy

          ### Artifacts
          - `test-project-*` - Generated `.claude/` directory for each project type (7 artifacts)

          ---

          ## üìö Documentation Verification

          **Status:** ${{ needs.verify-documentation.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}

          ### Checks Performed
          - ‚úì README.md mentions progressive disclosure
          - ‚úì ARCHITECTURE.md explains progressive disclosure design
          - ‚úì All rule files use `.md` extension
          - ‚úì Internal markdown links validation

          ---

          ## üéØ Overall Status

          REPORT_EOF

          # Determine overall status
          if [ "${{ needs.validate-progressive-disclosure.result }}" == "success" ] && \
             [ "${{ needs.shellcheck.result }}" == "success" ] && \
             [ "${{ needs.test-sync-script.result }}" == "success" ] && \
             [ "${{ needs.verify-documentation.result }}" == "success" ]; then
            echo "### ‚úÖ ALL TESTS PASSED" >> test-report.md
            echo "" >> test-report.md
            echo "All test suites completed successfully. The progressive disclosure architecture is validated and working correctly across all scenarios." >> test-report.md
            overall_status="success"
          else
            echo "### ‚ùå TESTS FAILED" >> test-report.md
            echo "" >> test-report.md
            echo "One or more test suites failed. Please review the individual test results above and check the workflow logs for details." >> test-report.md
            echo "" >> test-report.md
            echo "#### Failed Tests:" >> test-report.md
            [ "${{ needs.validate-progressive-disclosure.result }}" != "success" ] && echo "- Progressive Disclosure Validation" >> test-report.md
            [ "${{ needs.shellcheck.result }}" != "success" ] && echo "- ShellCheck Linting" >> test-report.md
            [ "${{ needs.test-sync-script.result }}" != "success" ] && echo "- Sync Script Testing" >> test-report.md
            [ "${{ needs.verify-documentation.result }}" != "success" ] && echo "- Documentation Verification" >> test-report.md
            overall_status="failure"
          fi

          echo "" >> test-report.md
          echo "---" >> test-report.md
          echo "" >> test-report.md
          echo "**Workflow URL:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> test-report.md

          # Output to job summary
          cat test-report.md >> $GITHUB_STEP_SUMMARY

          # Save status for next step
          echo "status=$overall_status" >> $GITHUB_OUTPUT
        id: report

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
          retention-days: 30

      - name: Fail if tests failed
        if: steps.report.outputs.status != 'success'
        run: |
          echo "‚ùå One or more test suites failed"
          exit 1
