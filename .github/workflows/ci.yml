name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # Progressive Disclosure Validation
  progressive-disclosure:
    name: Progressive Disclosure
    uses: ./.github/workflows/ci-progressive-disclosure.yml

  # Code Quality Checks (ShellCheck + Documentation)
  quality:
    name: Code Quality
    uses: ./.github/workflows/ci-quality.yml

  # Sync Script Integration Tests
  sync-script:
    name: Sync Script Tests
    uses: ./.github/workflows/ci-sync-script.yml

  # Claude Skill Tests
  skill:
    name: Claude Skill
    uses: ./.github/workflows/ci-skill.yml

  # Keyword Validation Tests
  keyword-validation:
    name: Keyword Validation
    uses: ./.github/workflows/ci-keyword-validation.yml

  # Generate comprehensive test report
  report:
    name: Test Report
    runs-on: ubuntu-latest
    needs:
      - progressive-disclosure
      - quality
      - sync-script
      - skill
      - keyword-validation
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate comprehensive test report
        id: report
        run: scripts/ci/generate-test-report.sh >> $GITHUB_OUTPUT
        env:
          PROGRESSIVE_DISCLOSURE_STATUS: ${{ needs.progressive-disclosure.result }}
          QUALITY_STATUS: ${{ needs.quality.result }}
          SYNC_SCRIPT_STATUS: ${{ needs.sync-script.result }}
          SKILL_STATUS: ${{ needs.skill.result }}
          KEYWORD_VALIDATION_STATUS: ${{ needs.keyword-validation.result }}

      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-main-test-report
          path: test-report.md
          retention-days: 30

      - name: Fail if tests failed
        if: steps.report.outputs.status != 'success'
        run: |
          echo "‚ùå One or more test suites failed"
          exit 1
