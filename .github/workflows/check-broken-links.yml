name: Check Broken Links

on:
  push:
    branches: [main]
    paths:
      - '.claude/**'
      - '.github/markdown-link-check-config.json'
      - '.github/workflows/check-broken-links.yml'
      - '**.md'
      - 'base/**'
      - 'frameworks/**'
      - 'languages/**'
      - 'cloud/**'
      - 'scripts/check-json-references.sh'
  pull_request:
    paths:
      - '.claude/**'
      - '.github/markdown-link-check-config.json'
      - '.github/workflows/check-broken-links.yml'
      - '**.md'
      - 'base/**'
      - 'frameworks/**'
      - 'languages/**'
      - 'cloud/**'
      - 'scripts/check-json-references.sh'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check-json-references:
    name: Check JSON File References
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check JSON file references
        run: |
          chmod +x scripts/check-json-references.sh
          ./scripts/check-json-references.sh

  check-markdown-links:
    name: Check Markdown Links (Critical)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Remove symlinked markdown files to avoid duplicate checking
        run: |
          # Remove markdown file symlinks in docs/ to prevent double-checking with wrong paths
          find docs/ -type l -name "*.md" -delete

      - name: Check markdown links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          config-file: '.github/markdown-link-check-config.json'
          check-modified-files-only: 'no'

  check-flaky-links:
    name: Check Flaky Links (Advisory)
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check known-flaky links (W3C, GNU, AgentSkills)
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'no'
          use-verbose-mode: 'yes'
          config-file: '.github/markdown-link-check-config-flaky.json'
          check-modified-files-only: 'no'
        continue-on-error: true

      - name: Report flaky link results
        if: always()
        run: |
          echo "⚠️  Flaky link check completed (advisory only - does not block CI)"
          echo "This job checks W3C, GNU, AgentSkills, and other domains that block automated checkers."
          echo "Failures here should be investigated but won't block the build."
          echo "Last manual verification: 2025-12-28"
