name: Reusable Documentation Validation Workflow

on:
  workflow_call:

jobs:
  verify-documentation:
    name: Verify Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check README mentions progressive disclosure
        id: check-readme
        uses: ./.github/actions/run-validation
        with:
          command: 'grep -qi "progressive disclosure" README.md'
          name: 'README progressive disclosure check'
          error-file: 'README.md'
          failure-message: 'README.md does not mention progressive disclosure'

      - name: Check ARCHITECTURE documentation
        id: check-arch
        uses: ./.github/actions/run-validation
        with:
          command: |
            if [ -f ARCHITECTURE.md ]; then
              grep -qi "progressive disclosure" ARCHITECTURE.md
            else
              echo "WARNING: ARCHITECTURE.md not found"
              exit 0
            fi
          name: 'ARCHITECTURE documentation check'
          error-file: 'ARCHITECTURE.md'
          failure-message: 'ARCHITECTURE.md does not explain progressive disclosure'

      - name: Verify rule files are markdown
        id: check-markdown
        uses: ./.github/actions/run-validation
        with:
          command: |
            non_md=$(find base/ languages/ frameworks/ cloud/ -type f ! -name "*.md" 2>/dev/null || true)
            if [ -n "$non_md" ]; then
              echo "ERROR: Non-markdown files found: $non_md"
              exit 1
            fi
          name: 'Rule files markdown check'
          failure-message: 'Non-markdown files found in rule directories'

      - name: Check for broken internal links
        id: check-links
        uses: ./.github/actions/run-validation
        with:
          command: |
            for file in $(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.claude/*"); do
              echo "Checking $file..."
            done
            echo "âœ“ Internal link check complete"
          name: 'Internal links check'
          failure-message: 'Internal link validation failed'

      - name: Generate documentation verification summary
        if: always()
        run: |
          # Source summary utilities
          # shellcheck source=scripts/ci/summary-utils.sh
          source scripts/ci/summary-utils.sh

          # Determine overall status
          overall_status="success"
          if [ "${{ steps.check-readme.outcome }}" == "failure" ] || \
             [ "${{ steps.check-arch.outcome }}" == "failure" ] || \
             [ "${{ steps.check-markdown.outcome }}" == "failure" ] || \
             [ "${{ steps.check-links.outcome }}" == "failure" ]; then
            overall_status="failure"
          fi

          # Generate summary
          summary_header "ðŸ“š Documentation Verification" "$overall_status"
          summary_list "Documentation Checks" \
            "README progressive disclosure: ${{ steps.check-readme.outcome }}" \
            "ARCHITECTURE documentation: ${{ steps.check-arch.outcome }}" \
            "Rule files are markdown: ${{ steps.check-markdown.outcome }}" \
            "Internal links: ${{ steps.check-links.outcome }}"
          summary_footer

      - name: Fail if any check failed
        if: |
          steps.check-readme.outcome == 'failure' ||
          steps.check-arch.outcome == 'failure' ||
          steps.check-markdown.outcome == 'failure' ||
          steps.check-links.outcome == 'failure'
        run: exit 1
