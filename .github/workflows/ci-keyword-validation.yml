name: Keyword Validation Tests

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test-keyword-validation:
    name: Test Keyword Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run keyword validation tests
        id: test
        run: |
          chmod +x scripts/test-keyword-validation.sh
          # Run tests and capture output
          ./scripts/test-keyword-validation.sh --num-tests 10 2>&1 | tee test-output.log
          # Preserve exit code
          exit ${PIPESTATUS[0]}
        continue-on-error: true

      - name: Parse test results
        if: always()
        id: parse
        run: |
          # Extract test summary
          if [ -f test-output.log ]; then
            echo "## Keyword Validation Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract summary stats
            total=$(grep "Total Tests:" test-output.log | awk '{print $3}' || echo "0")
            passed=$(grep "Passed:" test-output.log | grep -oP '\d+' | head -1 || echo "0")
            failed=$(grep "Failed:" test-output.log | grep -oP '\d+' | tail -1 || echo "0")

            echo "- **Total Tests**: $total" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed**: ✅ $passed" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed**: ❌ $failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract failed keywords if any
            if [ "$failed" != "0" ]; then
              echo "### ❌ Failed Keywords" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              sed -n '/Failed Keywords:/,/^$/p' test-output.log | grep "  -" >> $GITHUB_STEP_SUMMARY || echo "See test output for details" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Save failed keywords for next step
              sed -n '/Failed Keywords:/,/^$/p' test-output.log | grep "  -" | sed 's/  - //' > failed-keywords.txt || true
            fi
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keyword-validation-results
          path: |
            test-output.log
            failed-keywords.txt
          retention-days: 30

      - name: Check test results
        if: steps.test.outcome == 'failure'
        run: |
          echo "::error::Keyword validation tests failed!"
          echo ""

          if [ -f failed-keywords.txt ]; then
            echo "Failed keywords:"
            cat failed-keywords.txt | while read keyword; do
              echo "  - $keyword"
            done
            echo ""
            echo "These keywords in skill-rules.json are not correctly triggering their expected rules."
          else
            echo "Some keywords in skill-rules.json are not correctly triggering their expected rules."
          fi

          echo ""
          echo "To debug locally, run:"
          echo "  ./scripts/test-keyword-validation.sh --verbose"
          echo ""
          echo "See the job summary for detailed test results."
          exit 1

      - name: Report success
        if: steps.test.outcome == 'success'
        run: |
          echo "✅ All keyword validation tests passed!"
          echo "All keywords in skill-rules.json correctly trigger their expected rules."
