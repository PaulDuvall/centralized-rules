name: Keyword Validation Tests

on:
  workflow_call:

permissions:
  contents: read

jobs:
  test-keyword-validation:
    name: Test Keyword Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Run keyword validation tests
        id: test
        run: |
          chmod +x scripts/test-keyword-validation.sh
          # Run tests and capture output
          ./scripts/test-keyword-validation.sh --num-tests 10 2>&1 | tee test-output.log
          # Preserve exit code
          exit ${PIPESTATUS[0]}
        continue-on-error: true

      - name: Parse test results
        if: always()
        id: parse
        run: |
          # Source summary utilities
          # shellcheck source=scripts/ci/summary-utils.sh
          source scripts/ci/summary-utils.sh

          # Extract test summary
          if [ -f test-output.log ]; then
            # Extract summary stats
            total=$(grep "Total Tests:" test-output.log | awk '{print $3}' || echo "0")
            passed=$(grep "Passed:" test-output.log | grep -oP '\d+' | head -1 || echo "0")
            failed=$(grep "Failed:" test-output.log | grep -oP '\d+' | tail -1 || echo "0")

            # Determine status
            status="success"
            [ "$failed" != "0" ] && status="failure"

            # Generate summary
            summary_header "Keyword Validation Test Results" "$status"
            summary_test_results "$total" "$passed" "$failed"

            # Add failed keywords if any
            if [ "$failed" != "0" ]; then
              failed_keywords=$(sed -n '/Failed Keywords:/,/^$/p' test-output.log | grep "  -" || echo "See test output for details")
              summary_details "âŒ Failed Keywords" "$failed_keywords"

              # Save failed keywords for next step
              sed -n '/Failed Keywords:/,/^$/p' test-output.log | grep "  -" | sed 's/  - //' > failed-keywords.txt || true
            fi

            summary_footer
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: keyword-validation-results
          path: |
            test-output.log
            failed-keywords.txt
          retention-days: 30

      - name: Check test results
        if: steps.test.outcome == 'failure'
        run: scripts/ci/format-keyword-errors.sh

      - name: Report success
        if: steps.test.outcome == 'success'
        run: |
          echo "âœ… All keyword validation tests passed!"
          echo ""

          if [ -f test-output.log ]; then
            # Extract and show test statistics
            total=$(grep "Total Tests:" test-output.log | awk '{print $3}' || echo "unknown")
            echo "ðŸ“Š Test Statistics:"
            echo "   Total keywords tested: $total"
            echo "   Result: All passed âœ…"
            echo ""
          fi

          echo "All keywords in skill-rules.json correctly trigger their expected rules."
          echo ""
          echo "See the job summary tab for detailed test results."
